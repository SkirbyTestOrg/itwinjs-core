# Testing

## Dependencies

Tests have these primary dependencies:
- [mocha](https://mochajs.org/) test framework
- [chai](http://chaijs.com/) assertion library. It supports different
assertion styles. Inside the repository we use `expect`.
- [typemoq](https://github.com/florinn/typemoq) mocking library. Chosen
mostly because it was written for typescript as opposed to most other
popular javascript libraries which have typescript declarations.

## Running the Tests

To run all tests in the repository, just `rush test -v`.

You can also run tests for each package separately:
1. `cd packages/{package-name}`
2. `npm run test -s`

## Measuring Coverage

To measure test coverage of all code in the repository, just `rush cover -v`.

You can also measure coverage of each package by running its unit tests:
1. `cd packages/{package-name}`
2. `npm run cover -s`

Integration tests involve all packages. To measure code coverage of integration tests:
1. `cd packages/integration-tests`
2. `npm run cover -s`

Running the coverage script shows the coverage in the console output. Also,
it generates an HTML report in `out/reports/coverage`. Each package
coverage is put under a sub-directory.

A combined coverage report for all source code in the repository can be
generated by going to the repository root and executing the following command:
`npm run cover:merge`. The report is created in `out/reports/coverage/merged`.

**Important**: It's required that unit tests cover published packages at **100%**.

## Helpers

Inside the `packages` directory there's a sub-directory `test-helpers`
which is not really a package, but just a directory containing various
test helper code. The code inside the directory can be imported from
test code using `@helpers` scope, e.g.:
```ts
import { spy } from "@helpers/Spies";
```

### Mocks

As noted previously, we use [typemoq](https://github.com/florinn/typemoq)
mocking library. It has [one caveat](https://github.com/florinn/typemoq/issues/70)
which disallows returning mocked objects as `Promises` - the promises
never get resolved. To help with the problem, we have a test
helper `configureForPromiseResult`:
```ts
import * as moq from "@helpers/Mocks";
const mock = moq.Mock.ofType<SomeClass>();
moq.configureForPromiseResult(mock);
const someFunctionReturningAPromise = () => Promise.resolve(mock.object);
// the below would never resolve without calling 'configureForPromiseResult'
const result = await someFunctionReturningAPromise();
```

### Spies

We use [chai-spies](https://github.com/chaijs/chai-spies) library for
spying on external function calls. To help with its setup we have a test
helper:
```ts
import { spy } from "@helpers/Spies";
const mySpy = spy.on(SomeClass, SomeClass.prototype.someFunction.name);
// do something that makes SomeClass.someFunction to be called
expect(mySpy).to.be.called();
```
**Important:** Do not hard-code function names. Instead, use the `name`
property of the function object which can be accessed either from class
(in case the function is static) or its prototype (in case it's an
instance function).

### Snapshots

Validating large data structures can be a tedious task. To help with the
problem, we use [snapshots](https://github.com/suchipi/chai-jest-snapshot).
To help with their setup, we have a test helper:
```ts
import "@helpers/Snapshots";
describe("MyClass", () => {
  it("does something", () => {
    const result = MyClass.doesSomething();
    expect(result).to.matchSnapshot();
  });
});
```
The first time the test is run, a new snapshot is generated. Each test
source file gets a separate snapshot file with a `.snap` extension. Inside
the file there can be multiple snapshots.

Generally, after the first test run test writer should verify that a valid
snapshot was generated. Afterwards, `matchSnapshot` with compare with the
existing snapshot and fail if there are any differences.

### Fake Data

We use [faker](https://github.com/Marak/Faker.js) for creating random fake
data. Additionally, we have some test helpers that generate random commonly
used objects. They are located in the `test-helpers/random` sub-directory:
```ts
import { createRandomDescriptor } from "@helpers/random/Content";
const descriptor = createRandomDescriptor();
```
